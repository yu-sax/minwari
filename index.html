<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã¿ã‚“ã‚ã‚Š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, select, button, textarea { margin: 5px 0; width: 100%; padding: 8px; }
    .section { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 5px; }
    .actions {
      display: inline-flex;
      gap: 4px;
      float: right;
    }
    .actions button {
      font-size: 12px;
      padding: 2px 6px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 4px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      input, select, button { font-size: 16px; }
    }
  </style>
</head>
<body>

<h1>ã¿ã‚“ã‚ã‚Š - å‰²ã‚Šå‹˜è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>

<div class="section">
  <h2>ã‚°ãƒ«ãƒ¼ãƒ—é¸æŠ</h2>
  <label>ã‚°ãƒ«ãƒ¼ãƒ—åï¼š
    <input type="text" id="groupNameInput" placeholder="ä¾‹ï¼šæ—…è¡Œ2025" />
  </label>
  <button onclick="loadGroup()">ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã§é–‹å§‹</button>
  <p id="currentGroupLabel"></p>
</div>

<div id="mainApp" style="display: none;">
  <div class="section">
    <h2>1. åå‰ã‚’ç™»éŒ²ï¼ˆæœ€å¤§40åï¼‰</h2>
    <input type="text" id="nameInput" placeholder="åå‰ã‚’å…¥åŠ›" />
    <button onclick="addPerson()">è¿½åŠ </button>
    <p id="nameList"></p>
  </div>

  <div class="section">
    <h2>2. æ”¯æ‰•ã„ç™»éŒ²</h2>
    <label>æ”¯æ‰•ã£ãŸäººï¼š
      <select id="payerSelect"></select>
    </label>
    <label>é‡‘é¡ï¼š<input type="number" id="amountInput" /></label>
    <label>æ”¯æ‰•å†…å®¹ï¼ˆãƒ¡ãƒ¢ï¼‰ï¼š<input type="text" id="noteInput" /></label>
    <label>æ—¥ä»˜ï¼š<input type="date" id="dateInput" /></label>

    <label>å¯¾è±¡ï¼š
      <select id="targetOption" onchange="updateTargetOptions()">
        <option value="all">ã¿ã‚“ãªåˆ†æ‰•ã£ãŸ</option>
        <option value="exceptMe">è‡ªåˆ†ä»¥å¤–ã®ã¿ã‚“ãª</option>
        <option value="custom">è‡ªåˆ†ã§é¸æŠ</option>
      </select>
    </label>

    <div id="customCheckboxes" class="checkbox-group"></div>

    <button id="submitBtn" onclick="submitPayment()">ç™»éŒ²</button>

    <ul id="paymentList"></ul>
  </div>

  <div class="section">
    <h2>3. å‰²ã‚Šå‹˜çµæœ</h2>
    <button onclick="calculate()">è¨ˆç®—ã™ã‚‹</button>
    <pre id="result"></pre>
  </div>
</div>

<script>
  let names = [];
  let payments = [];
  let editingIndex = -1;
  let currentGroup = "";

  function getStorageKey() {
    return "minwari_" + currentGroup;
  }

  function saveData() {
    const data = { names, payments };
    localStorage.setItem(getStorageKey(), JSON.stringify(data));
  }

  function loadData() {
    const saved = localStorage.getItem(getStorageKey());
    if (saved) {
      const data = JSON.parse(saved);
      names = data.names || [];
      payments = data.payments || [];
    } else {
      names = [];
      payments = [];
    }
  }

  function loadGroup() {
    const input = document.getElementById("groupNameInput").value.trim();
    if (!input) {
      alert("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
      return;
    }
    currentGroup = input;
    document.getElementById("mainApp").style.display = "block";
    document.getElementById("currentGroupLabel").innerText = `ç¾åœ¨ã®ã‚°ãƒ«ãƒ¼ãƒ—: ${currentGroup}`;
    loadData();
    updateUI();
  }

  function addPerson() {
    const name = document.getElementById("nameInput").value.trim();
    if (!name || names.includes(name)) return;
    if (names.length >= 40) {
      alert("40åã¾ã§ç™»éŒ²å¯èƒ½ã§ã™");
      return;
    }
    names.push(name);
    saveData();
    updateUI();
    document.getElementById("nameInput").value = "";
  }

  function updateUI() {
    updateNameList();
    updatePayerSelect();
    updateTargetCheckboxes();
    renderPaymentList();
  }

  function updateNameList() {
    document.getElementById("nameList").innerText = names.join(", ");
  }

  function updatePayerSelect() {
    const select = document.getElementById("payerSelect");
    select.innerHTML = "";
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.innerText = name;
      select.appendChild(opt);
    });
  }

  function updateTargetCheckboxes() {
    const div = document.getElementById("customCheckboxes");
    div.innerHTML = "";
    names.forEach(name => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = name;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(name));
      div.appendChild(label);
    });
  }

  function updateTargetOptions() {
    const targetType = document.getElementById("targetOption").value;
    document.getElementById("customCheckboxes").style.display = (targetType === "custom") ? "flex" : "none";
  }

  function submitPayment() {
    const payer = document.getElementById("payerSelect").value;
    const amount = parseFloat(document.getElementById("amountInput").value);
    const note = document.getElementById("noteInput").value.trim();
    const date = document.getElementById("dateInput").value;
    const targetType = document.getElementById("targetOption").value;

    let targets = [];
    if (targetType === "all") {
      targets = [...names];
    } else if (targetType === "exceptMe") {
      targets = names.filter(n => n !== payer);
    } else {
      const checkboxes = document.querySelectorAll("#customCheckboxes input:checked");
      targets = Array.from(checkboxes).map(cb => cb.value);
    }

    if (amount <= 0 || targets.length === 0) {
      alert("æ­£ã—ã„é‡‘é¡ã¨å¯¾è±¡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const payment = { payer, amount, targets, note, date };

    if (editingIndex >= 0) {
      payments[editingIndex] = payment;
      editingIndex = -1;
      document.getElementById("submitBtn").innerText = "ç™»éŒ²";
    } else {
      payments.push(payment);
    }

    saveData();
    updateUI();

    document.getElementById("amountInput").value = "";
    document.getElementById("noteInput").value = "";
    document.getElementById("dateInput").value = "";
    document.querySelectorAll("#customCheckboxes input").forEach(cb => cb.checked = false);
  }

  function editPayment(index) {
    const p = payments[index];
    document.getElementById("payerSelect").value = p.payer;
    document.getElementById("amountInput").value = p.amount;
    document.getElementById("noteInput").value = p.note;
    document.getElementById("dateInput").value = p.date;

    document.getElementById("targetOption").value = "custom";
    updateTargetOptions();
    document.querySelectorAll("#customCheckboxes input").forEach(cb => {
      cb.checked = p.targets.includes(cb.value);
    });

    editingIndex = index;
    document.getElementById("submitBtn").innerText = "æ›´æ–°";
  }

  function deletePayment(index) {
    if (confirm("ã“ã®æ”¯æ‰•ã„ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã„ã§ã™ã‹ï¼Ÿ")) {
      payments.splice(index, 1);
      saveData();
      updateUI();
    }
  }

  function renderPaymentList() {
    const ul = document.getElementById("paymentList");
    ul.innerHTML = "";
    payments.forEach((p, i) => {
      const li = document.createElement("li");
      li.innerHTML = `
        [${p.date || "æ—¥ä»˜ãªã—"}] ${p.payer} ãŒ ${p.targets.join(", ")} ã« Â¥${p.amount}ï¼ˆ${p.note || "å†…å®¹ãªã—"}ï¼‰
        <div class="actions">
          <button onclick="editPayment(${i})">ğŸ“</button>
          <button onclick="deletePayment(${i})">ğŸ—‘</button>
        </div>
      `;
      ul.appendChild(li);
    });
  }

  function calculate() {
    const paid = {}, shouldPay = {};
    names.forEach(name => { paid[name] = 0; shouldPay[name] = 0; });

    payments.forEach(p => {
      paid[p.payer] += p.amount;
      const perPerson = p.amount / p.targets.length;
      p.targets.forEach(name => {
        shouldPay[name] += perPerson;
      });
    });

    const net = {};
    names.forEach(name => {
      net[name] = paid[name] - shouldPay[name];
    });

    const creditors = [], debtors = [];
    names.forEach(name => {
      const val = net[name];
      if (val > 0.01) creditors.push({ name, amount: val });
      else if (val < -0.01) debtors.push({ name, amount: -val });
    });

    const result = [];
    while (creditors.length && debtors.length) {
      const c = creditors[0], d = debtors[0];
      const min = Math.min(c.amount, d.amount);
      result.push(`${d.name} â†’ ${c.name} ã« Â¥${min.toFixed(0)}`);
      c.amount -= min;
      d.amount -= min;
      if (c.amount < 0.01) creditors.shift();
      if (d.amount < 0.01) debtors.shift();
    }

    document.getElementById("result").innerText = result.join("\n") || "ç²¾ç®—ä¸è¦ã§ã™ï¼";
  }

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œ
  window.onload = () => {
    const params = new URLSearchParams(location.search);
    if (params.has("group")) {
      document.getElementById("groupNameInput").value = params.get("group");
      loadGroup();
    }
  };
</script>

</body>
</html>
