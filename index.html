<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>みんわり</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    input, select, button, textarea { margin: 5px 0; width: 100%; padding: 8px; }
    .section { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; }
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 5px; }
    @media (max-width: 600px) {
      input, select, button { font-size: 16px; }
    }
  </style>
</head>
<body>

<h1>みんわり - 割り勘計算アプリ</h1>

<div class="section">
  <h2>1. 名前を登録（最大40名）</h2>
  <input type="text" id="nameInput" placeholder="名前を入力" />
  <button onclick="addPerson()">追加</button>
  <p id="nameList"></p>
</div>

<div class="section">
  <h2>2. 支払い登録</h2>
  <label>支払った人：
    <select id="payerSelect"></select>
  </label>
  <label>金額：<input type="number" id="amountInput" /></label>
  <label>支払内容（メモ）：<input type="text" id="noteInput" /></label>
  <label>日付：<input type="date" id="dateInput" /></label>

  <label>対象：
    <select id="targetOption" onchange="updateTargetOptions()">
      <option value="all">みんな分払った</option>
      <option value="exceptMe">自分以外のみんな</option>
      <option value="custom">自分で選択</option>
    </select>
  </label>

  <div id="customCheckboxes" class="checkbox-group"></div>

  <button onclick="addPayment()">登録</button>

  <ul id="paymentList"></ul>
</div>

<div class="section">
  <h2>3. 割り勘結果</h2>
  <button onclick="calculate()">計算する</button>
  <pre id="result"></pre>
</div>

<div class="section">
  <h2>4. 状態を共有する</h2>
  <button onclick="generateShareURL()">共有用URLをコピー</button>
  <textarea id="shareURL" rows="3" readonly></textarea>
</div>

<script>
  let names = [];
  let payments = [];

  function saveData() {
    localStorage.setItem("minwari_names", JSON.stringify(names));
    localStorage.setItem("minwari_payments", JSON.stringify(payments));
  }

  function loadData() {
    names = JSON.parse(localStorage.getItem("minwari_names") || "[]");
    payments = JSON.parse(localStorage.getItem("minwari_payments") || "[]");
  }

  function addPerson() {
    const name = document.getElementById("nameInput").value.trim();
    if (!name || names.includes(name)) return;
    if (names.length >= 40) {
      alert("40名まで登録可能です");
      return;
    }
    names.push(name);
    saveData();
    updateUI();
    document.getElementById("nameInput").value = "";
  }

  function updateUI() {
    updateNameList();
    updatePayerSelect();
    updateTargetCheckboxes();
    renderPaymentList();
  }

  function updateNameList() {
    document.getElementById("nameList").innerText = names.join(", ");
  }

  function updatePayerSelect() {
    const select = document.getElementById("payerSelect");
    select.innerHTML = "";
    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.innerText = name;
      select.appendChild(opt);
    });
  }

  function updateTargetCheckboxes() {
    const div = document.getElementById("customCheckboxes");
    div.innerHTML = "";
    names.forEach(name => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = name;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(name));
      div.appendChild(label);
    });
  }

  function updateTargetOptions() {
    const targetType = document.getElementById("targetOption").value;
    document.getElementById("customCheckboxes").style.display = (targetType === "custom") ? "flex" : "none";
  }

  function addPayment() {
    const payer = document.getElementById("payerSelect").value;
    const amount = parseFloat(document.getElementById("amountInput").value);
    const note = document.getElementById("noteInput").value.trim();
    const date = document.getElementById("dateInput").value;
    const targetType = document.getElementById("targetOption").value;

    let targets = [];
    if (targetType === "all") {
      targets = [...names];
    } else if (targetType === "exceptMe") {
      targets = names.filter(n => n !== payer);
    } else {
      const checkboxes = document.querySelectorAll("#customCheckboxes input:checked");
      targets = Array.from(checkboxes).map(cb => cb.value);
    }

    if (amount <= 0 || targets.length === 0) {
      alert("正しい金額と対象を選択してください。");
      return;
    }

    payments.push({ payer, amount, targets, note, date });
    saveData();
    updateUI();

    document.getElementById("amountInput").value = "";
    document.getElementById("noteInput").value = "";
    document.getElementById("dateInput").value = "";
    document.querySelectorAll("#customCheckboxes input").forEach(cb => cb.checked = false);
  }

  function renderPaymentList() {
    const ul = document.getElementById("paymentList");
    ul.innerHTML = "";
    payments.forEach((p, i) => {
      const li = document.createElement("li");
      li.innerText = `[${p.date || "日付なし"}] ${p.payer} が ${p.targets.join(", ")} に ¥${p.amount}（${p.note || "内容なし"}）`;
      ul.appendChild(li);
    });
  }

  function calculate() {
    const paid = {}, shouldPay = {};
    names.forEach(name => { paid[name] = 0; shouldPay[name] = 0; });

    payments.forEach(p => {
      paid[p.payer] += p.amount;
      const perPerson = p.amount / p.targets.length;
      p.targets.forEach(name => {
        shouldPay[name] += perPerson;
      });
    });

    const net = {};
    names.forEach(name => {
      net[name] = paid[name] - shouldPay[name];
    });

    const creditors = [], debtors = [];
    names.forEach(name => {
      const val = net[name];
      if (val > 0.01) creditors.push({ name, amount: val });
      else if (val < -0.01) debtors.push({ name, amount: -val });
    });

    const result = [];
    while (creditors.length && debtors.length) {
      const c = creditors[0], d = debtors[0];
      const min = Math.min(c.amount, d.amount);
      result.push(`${d.name} → ${c.name} に ¥${min.toFixed(0)}`);
      c.amount -= min;
      d.amount -= min;
      if (c.amount < 0.01) creditors.shift();
      if (d.amount < 0.01) debtors.shift();
    }

    document.getElementById("result").innerText = result.join("\n") || "精算不要です！";
  }

  function generateShareURL() {
    const data = {
      names,
      payments
    };
    const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
    const url = `${location.origin}${location.pathname}?data=${encoded}`;
    document.getElementById("shareURL").value = url;
    navigator.clipboard.writeText(url).then(() => {
      alert("共有用URLをコピーしました！");
    });
  }

  function loadFromURL() {
    const params = new URLSearchParams(location.search);
    if (params.has("data")) {
      try {
        const json = decodeURIComponent(atob(params.get("data")));
        const obj = JSON.parse(json);
        if (obj.names && obj.payments) {
          names = obj.names;
          payments = obj.payments;
          saveData(); // 保存もしておく
        }
      } catch (e) {
        alert("共有URLの読み込みに失敗しました。");
      }
    }
  }

  // 初期ロード
  loadFromURL();
  loadData();
  updateUI();
</script>

</body>
</html>
